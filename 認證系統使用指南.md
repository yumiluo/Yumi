# 🔐 VR系統認證系統使用指南

## 🎯 功能概述

本系統已成功實現基於電子郵件的完整認證系統，包括：

- ✅ **用戶註冊**：支持新用戶註冊
- ✅ **用戶登錄**：支持已註冊用戶登錄
- ✅ **JWT認證**：使用JWT token進行API認證
- ✅ **角色管理**：支持controller和user角色
- ✅ **訪客模式**：無需註冊即可使用基本功能
- ✅ **安全加密**：密碼使用bcrypt加密存儲

## 🗄️ 數據庫配置

### MongoDB Atlas設置

1. **創建免費帳戶**
   - 訪問 [MongoDB Atlas](https://www.mongodb.com/atlas)
   - 註冊免費帳戶
   - 創建M0免費集群

2. **獲取連接字符串**
   ```bash
   mongodb+srv://your-username:your-password@cluster0.mongodb.net/vr-travel?retryWrites=true&w=majority
   ```

3. **配置環境變量**
   創建 `.env` 文件：
   ```bash
   MONGODB_URI=mongodb+srv://your-username:your-password@cluster0.mongodb.net/vr-travel?retryWrites=true&w=majority
   JWT_SECRET=your-super-secret-jwt-key-here
   PORT=5001
   ```

## 🚀 快速開始

### 1. 啟動系統

```bash
# 啟動後端（包含MongoDB連接）
npm run vr

# 啟動前端
npm run dev
```

### 2. 測試認證系統

```bash
# 運行完整認證測試
node test-auth-system.js
```

### 3. 訪問前端

打開瀏覽器訪問：http://localhost:3000

## 📱 用戶界面

### 登錄界面

- **郵箱輸入**：輸入已註冊的電子郵件
- **密碼輸入**：輸入對應密碼
- **登錄按鈕**：點擊進行登錄
- **訪客模式**：無需帳號即可使用
- **註冊鏈接**：點擊跳轉到註冊界面

### 註冊界面

- **郵箱輸入**：輸入有效的電子郵件地址
- **密碼輸入**：至少6個字符
- **確認密碼**：再次輸入密碼進行確認
- **註冊按鈕**：點擊完成註冊
- **返回登錄**：註冊完成後返回登錄界面

## 🔧 API端點

### 用戶註冊

```http
POST /api/register
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "password123"
}
```

**響應示例：**
```json
{
  "success": true,
  "message": "註冊成功，請登錄"
}
```

### 用戶登錄

```http
POST /api/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "password123"
}
```

**響應示例：**
```json
{
  "success": true,
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": "507f1f77bcf86cd799439011",
    "email": "user@example.com",
    "role": "user"
  },
  "message": "登錄成功"
}
```

### 創建會話（需要認證）

```http
POST /api/create-session
Authorization: Bearer <jwt-token>
Content-Type: application/json

{
  "theme": "Paris Tour"
}
```

**響應示例：**
```json
{
  "success": true,
  "sessionId": "SESSION-1234567890-ABC123",
  "joinCode": "JOIN-XYZ789",
  "theme": "Paris Tour",
  "message": "會話創建成功"
}
```

## 🧪 測試方法

### 1. 手動測試

#### 註冊新用戶
1. 訪問 http://localhost:3000
2. 點擊"沒有帳戶？點擊註冊"
3. 輸入郵箱和密碼
4. 點擊"註冊"

#### 登錄用戶
1. 在登錄界面輸入郵箱和密碼
2. 點擊"登錄"
3. 檢查是否成功跳轉到主界面

#### 創建會話
1. 登錄後點擊"控制器儀表板"
2. 點擊"創建旅遊團"
3. 輸入旅遊主題
4. 點擊"創建會話"

### 2. 自動化測試

```bash
# 安裝依賴
npm install axios

# 運行測試
node test-auth-system.js
```

## 🔍 故障排除

### 常見問題

#### 1. MongoDB連接失敗
```
❌ MongoDB連接失敗: connect ECONNREFUSED
```

**解決方案：**
- 檢查MongoDB Atlas連接字符串
- 確認網絡連接
- 檢查IP白名單設置

#### 2. JWT認證失敗
```
❌ JWT認證失敗: 無效的token
```

**解決方案：**
- 檢查token是否過期（24小時）
- 確認Authorization頭格式正確
- 重新登錄獲取新token

#### 3. 註冊失敗
```
❌ 該電子郵件已被註冊
```

**解決方案：**
- 使用不同的郵箱地址
- 或直接登錄現有帳戶

#### 4. 登錄失敗
```
❌ 無效的電子郵件或密碼
```

**解決方案：**
- 檢查郵箱和密碼是否正確
- 確認用戶已註冊
- 檢查密碼長度（至少6字符）

### 調試方法

#### 1. 檢查後端日誌
```bash
# 查看後端日誌
npm run vr
```

#### 2. 檢查前端控制台
1. 打開瀏覽器開發者工具
2. 查看Console標籤
3. 檢查Network標籤中的API請求

#### 3. 檢查數據庫
```bash
# 使用MongoDB Compass連接
# 查看vr-travel數據庫中的users集合
```

## 🔐 安全特性

### 密碼安全
- 使用bcrypt進行密碼哈希
- 鹽值長度：12位
- 密碼最小長度：6字符

### JWT安全
- 過期時間：24小時
- 簽名算法：HS256
- 包含用戶ID、郵箱、角色信息

### 輸入驗證
- 郵箱格式驗證
- 密碼長度驗證
- 防止SQL注入

## 📊 數據結構

### 用戶模型
```javascript
{
  _id: ObjectId,
  email: String (唯一, 小寫),
  password: String (bcrypt哈希),
  role: String ('controller' | 'user'),
  createdAt: Date,
  lastLogin: Date,
  updatedAt: Date
}
```

### 會話模型
```javascript
{
  id: String,
  joinCode: String,
  theme: String,
  createdBy: ObjectId,
  createdByEmail: String,
  createdAt: Date,
  devices: Map,
  currentVideo: String,
  playbackState: String,
  currentTime: Number
}
```

## 🚀 下一步開發

### 建議功能
1. **密碼重置**：忘記密碼時的重置功能
2. **郵箱驗證**：註冊後郵箱驗證
3. **社交登錄**：Google、Facebook等第三方登錄
4. **用戶資料**：個人資料管理
5. **權限管理**：更細緻的權限控制

### 性能優化
1. **Redis緩存**：JWT token緩存
2. **數據庫索引**：郵箱查詢優化
3. **連接池**：MongoDB連接優化

## 📞 技術支持

如果遇到問題，請：

1. 檢查本指南的故障排除部分
2. 查看後端控制台日誌
3. 檢查前端瀏覽器控制台
4. 運行自動化測試腳本
5. 檢查MongoDB Atlas連接狀態

## 🎉 總結

認證系統已完全集成到VR多設備視頻播放系統中，提供：

- **完整的用戶管理**：註冊、登錄、角色管理
- **安全的API認證**：JWT token認證
- **無縫的功能整合**：與現有功能完全兼容
- **生產級安全**：密碼加密、輸入驗證、錯誤處理

現在您可以安全地管理用戶，創建會話，並享受完整的VR多設備視頻同步體驗！🎯



